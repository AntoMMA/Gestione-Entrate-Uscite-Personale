<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Entrate e Uscite</title>
<style>
:root{
  --green:#3ddc84;
  --red:#ff5c5c;
  --bg:#0b0f14;
  --card:#0f1720;
  --text:#e8eef6;
  --accent1:#00ffea;
  --accent2:#6b5cff;
}
body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);}
.container{max-width:600px;margin:auto;padding:16px;}
.card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 4px 20px rgba(0,0,0,0.6);}
input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none;}
button{cursor:pointer;font-weight:bold;}
.entry-btn{background:var(--green);color:#062016;}
.exit-btn{background:var(--red);color:#3a0a0a;}
.log-item{display:flex;justify-content:space-between;padding:6px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:4px;}
h2,h3{text-align:center;}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.animated-rgb{background: linear-gradient(90deg, rgba(107,92,255,0.2), rgba(0,255,234,0.15), rgba(255,80,180,0.15)); border-radius:12px; padding:12px; animation: hue 8s linear infinite alternate;}
@keyframes hue {0% {background-position:0%} 100% {background-position:100%}}
.user-presence{margin-bottom:12px;}
.user-presence div{margin:2px 0;}
.user-presence span{margin-right:6px;font-weight:bold;}
canvas{background:var(--card);border-radius:12px;padding:12px;margin-top:12px;}
</style>
</head>
<body>
<div class="container">
  <!-- LOGIN / REGISTRAZIONE -->
  <div class="card" id="loginCard">
    <h2>Login / Registrazione</h2>
    <input type="text" id="nome" placeholder="Nome">
    <input type="text" id="cognome" placeholder="Cognome">
    <input type="text" id="telefono" placeholder="Telefono">
    <button id="btnLogin">Entra / Registrati</button>
    <div id="loginMsg"></div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" style="display:none;">
    <div class="animated-rgb user-presence" id="userPresence">
      <h3>Utenti Online</h3>
      <div id="usersList"></div>
    </div>

    <div class="topbar animated-rgb">
      <div id="greeting"></div>
      <button onclick="logout()">Logout</button>
    </div>

    <div class="card">
      <h3 style="color:var(--green)">Entrata (€)</h3>
      <input type="number" id="entryAmount" placeholder="Importo">
      <input type="text" id="entryReason" placeholder="Motivo">
      <button class="entry-btn" onclick="addEntry()">Aggiungi Entrata</button>
    </div>

    <div class="card">
      <h3 style="color:var(--red)">Uscita (€)</h3>
      <input type="number" id="exitAmount" placeholder="Importo">
      <input type="text" id="exitReason" placeholder="Motivo">
      <button class="exit-btn" onclick="addExit()">Aggiungi Uscita</button>
    </div>

    <div class="card">
      <h3>Totale</h3>
      <div id="totals">Entrate: €0 | Uscite: €0 | Saldo: €0</div>
      <button onclick="saveCalc()">Salva Calcolo Totale</button>
    </div>

    <div class="card">
      <h3>Log Entrate</h3>
      <div id="entryLog"></div>
      <h3>Log Uscite</h3>
      <div id="exitLog"></div>
      <h3>Storico Calcoli</h3>
      <div id="calcLog"></div>
    </div>

    <!-- GRAFICO MENSILE -->
    <div class="card">
      <h3>Spese Mensili</h3>
      <canvas id="monthlyChart"></canvas>
      <div id="monthlyComparison" style="text-align:center;margin-top:6px;"></div>
    </div>
  </div>
</div>

<!-- FIREBASE + CHART.JS VERSIONE MOBILE FRIENDLY -->
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // CONFIG FIREBASE
  const firebaseConfig = {
  apiKey: "AIzaSyDA8x2UcwoDBNbEZbsE5nGUNlLHI-aXUHA",
  authDomain: "gestionale-entrate-uscite-wr.firebaseapp.com",
  projectId: "gestionale-entrate-uscite-wr",
  storageBucket: "gestionale-entrate-uscite-wr.firebasestorage.app",
  messagingSenderId: "180959843310",
  appId: "1:180959843310:web:0800ebae9267f61071b4ff",
  measurementId: "G-XFL9ZH8K6T"
};
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let currentUser=null;
  let monthlyChart=null;

  // LOGIN / REGISTRAZIONE
  document.getElementById('btnLogin').onclick = async ()=>{
    const nome=document.getElementById('nome').value.trim();
    const cognome=document.getElementById('cognome').value.trim();
    const telefono=document.getElementById('telefono').value.trim();
    if(!telefono){document.getElementById('loginMsg').innerText="Inserisci il telefono"; return;}

    const usersCol = db.collection("users");
    const snap = await usersCol.where("telefono","==",telefono).get();

    if(snap.empty){
      // registrazione
      const docRef = await usersCol.add({nome,cognome,telefono,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
      currentUser={id:docRef.id,nome,cognome,telefono};
    } else {
      const d = snap.docs[0].data();
      currentUser={id:snap.docs[0].id,nome:d.nome,cognome:d.cognome,telefono:d.telefono};
    }

    document.getElementById('loginCard').style.display='none';
    document.getElementById('dashboard').style.display='block';
    document.getElementById('greeting').innerText=`Ciao ${currentUser.nome} ${currentUser.cognome}`;
    setOnline(true);
    listenData();
    listenUsersPresence();
    updateMonthlyChart();
  };

  // LOGOUT
  function logout(){
    setOnline(false);
    currentUser=null;
    document.getElementById('dashboard').style.display='none';
    document.getElementById('loginCard').style.display='block';
  }

  // ENTRATE / USCITE
  async function addEntry(){
    const amt=Number(document.getElementById('entryAmount').value);
    const reason=document.getElementById('entryReason').value;
    if(!amt){alert("Importo non valido"); return;}
    await db.collection("entries").add({userId:currentUser.id,amount:amt,reason,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    document.getElementById('entryAmount').value=''; document.getElementById('entryReason').value='';
    updateOnlineSaldo(); updateMonthlyChart();
  }
  async function addExit(){
    const amt=Number(document.getElementById('exitAmount').value);
    const reason=document.getElementById('exitReason').value;
    if(!amt){alert("Importo non valido"); return;}
    await db.collection("exits").add({userId:currentUser.id,amount:amt,reason,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    document.getElementById('exitAmount').value=''; document.getElementById('exitReason').value='';
    updateOnlineSaldo(); updateMonthlyChart();
  }

  // CALCOLO TOTALE
  function getTotals(){
    let entrate=0,uscite=0;
    document.querySelectorAll("#entryLog .log-item").forEach(i=>entrate+=Number(i.dataset.amt));
    document.querySelectorAll("#exitLog .log-item").forEach(i=>uscite+=Number(i.dataset.amt));
    return {entrate,uscite,net:entrate-uscite};
  }
  async function saveCalc(){
    const totals=getTotals();
    await db.collection("calcHistory").add({userId:currentUser.id,...totals,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    alert("Calcolo salvato");
  }

  // PRESENCE
  async function setOnline(status){
    if(!currentUser) return;
    await db.collection("presence").doc(currentUser.id).set({
      userId:currentUser.id,
      online:status,
      saldo:getTotals().net,
      lastActive:firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
  }
  async function updateOnlineSaldo(){if(currentUser) setOnline(true);}

  // LISTENERS
  function listenData(){
    db.collection("entries").where("userId","==",currentUser.id).orderBy("createdAt","desc")
      .onSnapshot(snap=>{
        const container=document.getElementById('entryLog'); container.innerHTML='';
        snap.docs.forEach(d=>{
          const dt=d.data();
          const div=document.createElement('div');
          div.className='log-item'; div.dataset.amt=dt.amount;
          div.innerText=`+€${dt.amount.toFixed(2)} | ${dt.reason}`;
          container.appendChild(div);
        });
        updateTotalsDisplay();
      });

    db.collection("exits").where("userId","==",currentUser.id).orderBy("createdAt","desc")
      .onSnapshot(snap=>{
        const container=document.getElementById('exitLog'); container.innerHTML='';
        snap.docs.forEach(d=>{
          const dt=d.data();
          const div=document.createElement('div');
          div.className='log-item'; div.dataset.amt=dt.amount;
          div.innerText=`-€${dt.amount.toFixed(2)} | ${dt.reason}`;
          container.appendChild(div);
        });
        updateTotalsDisplay();
      });

    db.collection("calcHistory").where("userId","==",currentUser.id).orderBy("createdAt","desc")
      .onSnapshot(snap=>{
        const container=document.getElementById('calcLog'); container.innerHTML='';
        snap.docs.forEach(d=>{
          const dt=d.data();
          const div=document.createElement('div');
          div.className='log-item';
          div.innerText=`Entrate: €${dt.entrate.toFixed(2)} | Uscite: €${dt.uscite.toFixed(2)} | Saldo: €${dt.net.toFixed(2)}`;
          container.appendChild(div);
        });
      });
  }
  function updateTotalsDisplay(){
    const totals=getTotals();
    document.getElementById('totals').innerText=`Entrate: €${totals.entrate.toFixed(2)} | Uscite: €${totals.uscite.toFixed(2)} | Saldo: €${totals.net.toFixed(2)}`;
  }

  // PRESENCE USERS
  function listenUsersPresence(){
    db.collection("presence").onSnapshot(snap=>{
      const container=document.getElementById("usersList"); container.innerHTML='';
      snap.docs.forEach(d=>{
        const dt=d.data();
        const color=dt.online?"green":"red";
        const name = dt.userId===currentUser.id ? `${currentUser.nome} ${currentUser.cognome}` : dt.userId;
        const div=document.createElement('div');
        div.innerHTML=`<span style="color:${color}">●</span>${name} - Saldo: €${(dt.saldo||0).toFixed(2)}`;
        container.appendChild(div);
      });
    });
  }

  // VISIBILITY API
  document.addEventListener("visibilitychange", ()=>{if(currentUser) setOnline(document.visibilityState==="visible");});
  window.addEventListener("beforeunload", ()=>setOnline(false));

  // GRAFICO MENSILE
  async function updateMonthlyChart(){
    const snap = await db.collection("exits").where("userId","==",currentUser.id).get();
    const data = snap.docs.map(d=>d.data());
    const now = new Date(); const thisMonth = now.getMonth(); const thisYear = now.getFullYear();
    const lastMonth = (thisMonth===0)?11:thisMonth-1;
    const lastMonthYear = (thisMonth===0)?thisYear-1:thisYear;
    let totalThisMonth=0,totalLastMonth=0;
    data.forEach(d=>{
      const date = d.createdAt?.toDate?.() || new Date();
      const m = date.getMonth(); const y=date.getFullYear();
      if(m===thisMonth && y===thisYear) totalThisMonth+=d.amount;
      if(m===lastMonth && y===lastMonthYear) totalLastMonth+=d.amount;
    });
    const perc = totalLastMonth===0 ? 0 : ((totalThisMonth-totalLastMonth)/totalLastMonth*100).toFixed(1);
    document.getElementById('monthlyComparison').innerText =
      perc>0 ? `Hai speso il ${perc}% in più rispetto al mese scorso` :
      perc<0 ? `Hai speso il ${Math.abs(perc)}% in meno rispetto al mese scorso` :
      `La spesa è uguale al mese scorso`;
    if(monthlyChart) monthlyChart.destroy();
    const ctx=document.getElementById('monthlyChart').getContext('2d');
    monthlyChart = new Chart(ctx,{
      type:'bar',
      data:{
        labels:['Mese Scorso','Mese Corrente'],
        datasets:[{label:'Uscite (€)',data:[totalLastMonth,totalThisMonth],backgroundColor:[totalThisMonth>=totalLastMonth?'red':'green','green']}]
      },
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  }
</script>
</body>
</html>
